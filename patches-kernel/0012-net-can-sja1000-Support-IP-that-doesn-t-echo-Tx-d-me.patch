From 6fd62d1cf74dc59128648c65ca42c2f44519bb4f Mon Sep 17 00:00:00 2001
From: Phil Edworthy <phil.edworthy@renesas.com>
Date: Wed, 5 Aug 2015 18:21:13 +0100
Subject: [PATCH] net: can: sja1000: Support IP that doesn't echo Tx'd messages

Signed-off-by: Phil Edworthy <phil.edworthy@renesas.com>
---
 Documentation/devicetree/bindings/net/can/sja1000.txt | 2 ++
 drivers/net/can/sja1000/sja1000.c                     | 4 +++-
 drivers/net/can/sja1000/sja1000.h                     | 1 +
 drivers/net/can/sja1000/sja1000_platform.c            | 3 +++
 4 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/Documentation/devicetree/bindings/net/can/sja1000.txt b/Documentation/devicetree/bindings/net/can/sja1000.txt
index a342c86..f294ae5 100644
--- a/Documentation/devicetree/bindings/net/can/sja1000.txt
+++ b/Documentation/devicetree/bindings/net/can/sja1000.txt
@@ -46,6 +46,8 @@ Optional properties:
 
 - nxp,no-cdr : Indicates that the Clock Divider Register is not present.
 
+- nxp,no-loopback : Indicates the hardware does not looback messages.
+
 For further information, please have a look to the SJA1000 data sheet.
 
 Examples:
diff --git a/drivers/net/can/sja1000/sja1000.c b/drivers/net/can/sja1000/sja1000.c
index 2f9e8bd..353d0225 100644
--- a/drivers/net/can/sja1000/sja1000.c
+++ b/drivers/net/can/sja1000/sja1000.c
@@ -668,12 +668,14 @@ static const struct net_device_ops sja1000_netdev_ops = {
 
 int register_sja1000dev(struct net_device *dev)
 {
+	struct sja1000_priv *priv = netdev_priv(dev);
 	int ret;
 
 	if (!sja1000_probe_chip(dev))
 		return -ENODEV;
 
-	dev->flags |= IFF_ECHO;	/* we support local echo */
+	if (!priv->no_loopback)
+		dev->flags |= IFF_ECHO;	/* we support local echo */
 	dev->netdev_ops = &sja1000_netdev_ops;
 
 	set_reset_mode(dev);
diff --git a/drivers/net/can/sja1000/sja1000.h b/drivers/net/can/sja1000/sja1000.h
index 19acad5..a07529d 100644
--- a/drivers/net/can/sja1000/sja1000.h
+++ b/drivers/net/can/sja1000/sja1000.h
@@ -171,6 +171,7 @@ struct sja1000_priv {
 	u8 ocr;			/* output control register */
 	u8 cdr;			/* clock divider register */
 	u8 cdr_missing;		/* missing clock divider register */
+	bool no_loopback;	/* HW doesn't see tx messages on rx */
 };
 
 struct net_device *alloc_sja1000dev(int sizeof_priv);
diff --git a/drivers/net/can/sja1000/sja1000_platform.c b/drivers/net/can/sja1000/sja1000_platform.c
index b26954b..b962f8f 100644
--- a/drivers/net/can/sja1000/sja1000_platform.c
+++ b/drivers/net/can/sja1000/sja1000_platform.c
@@ -203,6 +203,9 @@ static void sp_populate_of(struct sja1000_priv *priv, struct device_node *of)
 
 	if (of_property_read_bool(of, "nxp,no-cdr"))
 		priv->cdr_missing = 1;
+
+	if (of_property_read_bool(of, "nxp,no-loopback"))
+		priv->no_loopback = true;
 }
 
 static struct sja1000_of_data technologic_data = {
-- 
2.7.4

